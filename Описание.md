
На основе всей полученной информации, я могу составить полное и структурированное описание архитектуры и алгоритмов проекта:

# Документация к проекту "Симуляция эволюции коров"

## 1. Общая архитектура и вложенные модули

### Иерархия каталогов и файлов
```
root/
├── run_experiment.py        - Основной скрипт запуска экспериментов
├── run_plot.py              - Скрипт для построения графиков
├── agents/                  - Модули, реализующие агентов (коров)
│   ├── __init__.py
│   ├── cow.py               - Основной класс Cow
│   ├── death.py             - Логика смерти коров
│   ├── feeding.py           - Логика питания коров
│   ├── movement.py          - Логика передвижения коров
│   ├── reproduction.py      - Логика размножения коров
│   └── spatial_index.py     - Пространственный индекс для оптимизации
├── environment/             - Модули окружающей среды
│   ├── __init__.py 
│   └── world.py             - Класс World, представляющий мир симуляции
├── simulation/              - Симуляционный модуль
│   ├── __init__.py
│   └── simulation.py        - Основной класс Simulation
├── metrics/                 - Модули для сбора и анализа метрик
│   ├── __init__.py
│   └── collector.py         - Класс для сбора метрик
├── utils/                   - Утилиты и вспомогательные модули
│   ├── plotting_general.py  - Построение графиков для экспериментов
│   └── config_utils.py      - Утилиты для обработки конфигураций
└── experiments/             - Конфигурации экспериментов
    ├── experiment_map.json  - Карта экспериментов
    ├── mutation_rate/       - Эксперимент с разными скоростями мутаций
    │   ├── exp_config.json  - Конфигурация эксперимента
    │   ├── plot_config.json - Конфигурация графиков
    │   └── data/            - Директория для данных экспериментов
    ├── reproduction_comparison/  - Эксперимент сравнения типов размножения
    ├── climate_adaptation/  - Эксперимент адаптации к климату
    ├── intelligence_effect/ - Эксперимент с влиянием интеллекта
    ├── herding_behavior/    - Эксперимент со стадным поведением
    └── lifespan_effect/     - Эксперимент с влиянием продолжительности жизни
```

### Зависимости между модулями

1. **Основные зависимости:**
   - `run_experiment.py` ⟶ `simulation.simulation` ⟶ (`agents`, `environment`, `metrics`)
   - `run_plot.py` ⟶ `utils.plotting_general`
   - `agents.cow` ⟶ (`agents.movement`, `agents.feeding`, `agents.reproduction`, `agents.death`, `agents.spatial_index`)
   - `simulation.simulation` ⟶ `environment.world`
   - `metrics.collector` ⟶ `simulation.simulation`

2. **Поток данных:**
   - Конфигурация эксперимента загружается из JSON-файлов
   - Симуляция создается на основе конфигурации
   - Агенты (коровы) взаимодействуют с миром и между собой
   - Метрики собираются во время симуляции
   - Результаты анализируются и визуализируются через модуль построения графиков

## 2. Алгоритмы и их подробное изложение

### 1. Основной алгоритм симуляции эволюции

**Цель**: Моделировать эволюционное развитие популяции коров в одномерном мире с различными экологическими условиями.

**Pseudocode основного цикла симуляции:**
```
функция simulate(config, seed):
    создать симуляцию с config и seed
    пока симуляция выполняется и не достигнут лимит тиков:
        обновить мир (трава, климат)
        обновить коров (перемещение, питание, размножение)
        обработать смерти коров
        собрать метрики
        обновить статистику
    вернуть результаты симуляции

функция step():
    обновить мир (обновить траву и климат)
    обновить коров:
        переместить коров (movement)
        накормить коров (feeding)
        процесс размножения (reproduction)
    обработать смерти (death)
    обновить возраст всех коров
    вычислить метрики
    обновить статистику
```

### 2. Алгоритм перемещения коров

**Цель**: Моделирование передвижения коров по миру с учетом различных стратегий.

**Pseudocode:**
```
функция move_all_cows(cows, world, parameters):
    для каждой коровы в списке cows:
        если корова ожидает партнера:
            продолжить (пропустить ход)
        
        если у коровы есть цель для размножения:
            переместиться к партнеру для размножения
        иначе если корова голодная:
            найти и переместиться к ближайшей траве
        иначе если коровы стадные (параметр R > порог):
            найти и переместиться к другим коровам (стадное поведение)
        иначе:
            случайное перемещение
        
        вычислить затраты энергии на перемещение
```

### 3. Алгоритм питания коров

**Цель**: Моделирование процесса питания коров травой и получения энергии.

**Pseudocode:**
```
функция feed_all_cows(cows, world, parameters):
    для каждой коровы в списке cows:
        текущая_позиция = cow.position
        доступная_трава = world.patches[текущая_позиция].grass_amount
        
        если доступная_трава > 0:
            количество_еды = min(доступная_трава, cow.stomach_capacity)
            cow.energy += количество_еды * параметры.энергия_на_единицу_травы
            world.patches[текущая_позиция].grass_amount -= количество_еды
```

### 4. Алгоритм размножения

**Цель**: Моделирование процесса размножения коров с учетом полового и бесполого размножения.

**Pseudocode для бесполого размножения:**
```
функция asexual_reproduction(cow, parameters):
    если cow.energy >= минимальная_энергия_для_размножения и cow.age >= минимальный_возраст:
        создать новую корову с теми же параметрами
        применить мутацию к параметрам новой коровы с вероятностью mutation_rate
        уменьшить энергию родительской коровы
        вернуть новую корову
    иначе:
        вернуть None
```

**Pseudocode для полового размножения:**
```
функция sexual_reproduction(cow1, cow2, parameters):
    если обе коровы готовы к размножению:
        создать новую корову с усредненными параметрами от обоих родителей
        применить мутацию к параметрам новой коровы с вероятностью mutation_rate
        уменьшить энергию обоих родителей
        вернуть новую корову
    иначе:
        вернуть None
```

### 5. Алгоритм смерти коров

**Цель**: Моделирование естественной смерти коров с учетом возраста и других факторов.

**Pseudocode:**
```
функция process_deaths(cows, parameters):
    для каждой коровы в списке cows:
        если cow.energy <= 0:
            корова умирает от голода
        иначе:
            вычислить вероятность смерти на основе возраста и T0
            если случайное_число < вероятность_смерти:
                корова умирает естественной смертью
```

### 6. Алгоритм роста травы

**Цель**: Моделирование роста травы с учетом типа почвы и климата.

**Pseudocode:**
```
функция update(self):
    для каждой клетки в world.patches:
        текущая_трава = клетка.grass_amount
        максимальная_трава = клетка.max_grass
        скорость_роста = self.grass_speed * self.soil_factor[i]
        
        новая_трава = текущая_трава + (максимальная_трава - текущая_трава) * скорость_роста
        клетка.grass_amount = min(новая_трава, максимальная_трава)
```

### 7. Алгоритм мутации параметров

**Цель**: Моделирование эволюционных изменений в параметрах коров через мутации.

**Pseudocode:**
```
функция mutate_param(value, mutation_rate, param_ranges, param_name, fixed_params):
    если param_name в fixed_params:
        вернуть value
    
    если random() < mutation_rate:
        min_value = 1
        max_value = 10
        
        если param_ranges и param_name в param_ranges:
            min_value, max_value = param_ranges[param_name]
        
        мутация = случайное_целое_из(min_value, max_value)
        вернуть мутация
    иначе:
        вернуть value
```

## 3. Все математические формулы

### Расход энергии при перемещении
```
ΔE = AT_n * (S + traveled_distance) * temp_factor
```
где:
- `AT_n` — температура на текущей клетке
- `S` — размер коровы
- `traveled_distance` — пройденное расстояние за тик
- `temp_factor` — температурный коэффициент, зависящий от размера коровы:
  - Если жарко (AT_n = 2 или 3): `temp_factor = S/S_max`
  - Если холодно (AT_n = 0 или 1): `temp_factor = 1 - S/S_max`

### Вероятность смерти от старости
```
prob_death = age_factor * base_death_rate
```
где:
- `age_factor = cow.age / (cow.T0 * ticks_per_year)` — относительный возраст коровы
- `base_death_rate` — базовая вероятность смерти, определяемая из конфигурации

### Формула роста травы
```
new_grass = current_grass + (max_grass - current_grass) * growth_rate
growth_rate = grass_speed * soil_factor
```
где:
- `grass_speed` — базовая скорость роста травы
- `soil_factor` — коэффициент плодородности почвы (0-3)

### Расчет генетического разнообразия
```
diversity = 1 - sum((count_i / total)^2 for each unique genotype i)
```
где:
- `count_i` — количество коров с конкретным набором параметров
- `total` — общее количество коров

## 4. Описание каждой функции и метода

### Класс Cow (agents/cow.py)

#### `__init__(self, position, energy, S, V, M, IQ, W, R, T0, ...)`
**Описание**: Инициализирует корову с заданными параметрами.
**Параметры**:
- `S`: Размер (1-10)
- `V`: Скорость (1-10)
- `M`: Метаболизм (1-10)
- `IQ`: Интеллект (0-10)
- `W`: Зрение (1-10)
- `R`: Стадность (1-10)
- `T0`: Максимальная продолжительность жизни (1-10 лет)
- `position`: Начальная позиция в мире
- `energy`: Начальная энергия
- `mutation_rate`: Скорость мутации (0.0-1.0)
- `sexual_reproduce`: Тип размножения (0-бесполое, 1-половое)
- `stomach_size`: Базовый размер желудка
- `fixed_params`: Параметры, не подверженные мутации

#### `expend_energy(self, world)`
**Описание**: Расходует энергию коровы за тик в зависимости от температуры и размера.
**Особенности**: Учитывает адаптацию к климату: большие коровы лучше переносят холод, маленькие — жару.

#### `ready_for_reproduction(self, birth_energy)`
**Описание**: Проверяет, готова ли корова к размножению.
**Возвращает**: True если корова имеет достаточно энергии и достигла репродуктивного возраста.

#### `find_mate(self, cows, birth_energy)`
**Описание**: Находит подходящего партнера для размножения.
**Особенности**: Использует черный список для предотвращения "качелей" при поиске партнера.

#### `mutate_param(value, mutation_rate, param_ranges, param_name, fixed_params)`
**Описание**: Мутирует параметр с заданной вероятностью.
**Параметры**:
- `value`: Исходное значение параметра
- `mutation_rate`: Вероятность мутации (0.0-1.0)
- `param_ranges`: Допустимые диапазоны для параметров
- `param_name`: Имя параметра для проверки в fixed_params
- `fixed_params`: Список параметров, не подверженных мутации

### Класс World (environment/world.py)

#### `__init__(self, length, max_grass_amount, grass_speed, climate, soil, ...)`
**Описание**: Инициализирует мир с заданными параметрами.
**Параметры**:
- `length`: Длина мира (количество клеток)
- `max_grass_amount`: Максимальное количество травы на клетке
- `grass_speed`: Скорость роста травы
- `climate`: Словарь с климатическими зонами
- `soil`: Словарь с типами почвы
- `monotonous_mode`: Флаг монотонного режима (одна зона на весь мир)
- `monotonous_zone`: Тип зоны при монотонном режиме

#### `update(self)`
**Описание**: Обновляет состояние мира (рост травы) за один тик.
**Особенности**: Использует векторизованные операции NumPy для эффективности.

#### `update_season(self)`
**Описание**: Обновляет сезон и связанные с ним температуры.
**Особенности**: Использует предопределенные шаблоны температур для разных климатических зон.

### Класс Simulation (simulation/simulation.py)

#### `__init__(self, config)`
**Описание**: Инициализирует симуляцию с заданной конфигурацией.
**Параметры**:
- `config`: Словарь с полной конфигурацией симуляции

#### `create_world(self, config)`
**Описание**: Создает мир симуляции на основе конфигурации.

#### `initialize_population(self)`
**Описание**: Инициализирует начальную популяцию коров.
**Особенности**: Позволяет задавать фиксированные параметры, начальные позиции и энергию.

#### `_generate_cow_params(self, cow_params, cows_config)`
**Описание**: Генерирует параметры для новой коровы.
**Возвращает**: Словарь с параметрами (S, V, M, IQ, W, R, T0)

#### `step(self)`
**Описание**: Выполняет один шаг симуляции (один тик).
**Последовательность действий**:
1. Обновление мира
2. Перемещение коров
3. Питание коров
4. Размножение
5. Обработка смертей
6. Сбор метрик

#### `run(self, ticks)`
**Описание**: Запускает симуляцию на заданное количество тиков.
**Возвращает**: Словарь с результатами симуляции

### Класс MetricsCollector (metrics/collector.py)

#### `__init__(self, config)`
**Описание**: Инициализирует сборщик метрик.
**Параметры**:
- `config`: Конфигурация метрик

#### `collect_metrics(self, simulation, tick)`
**Описание**: Собирает все настроенные метрики для текущего тика.
**Возвращает**: Словарь с собранными метриками

#### `collect_base_metrics(self, simulation)`
**Описание**: Собирает базовые метрики (популяция, энергия, возраст).

#### `collect_genetic_metrics(self, simulation)`
**Описание**: Собирает генетические метрики (разнообразие, средние значения параметров).

#### `collect_spatial_metrics(self, simulation)`
**Описание**: Собирает пространственные метрики (распределение по зонам).

#### `collect_climate_metrics(self, simulation)`
**Описание**: Собирает метрики адаптации к климату.

#### `collect_lifecycle_metrics(self, simulation)`
**Описание**: Собирает метрики жизненного цикла (рождения, смерти, возраст).

#### `collect_extinction_metrics(self, simulation)`
**Описание**: Собирает метрики, связанные с риском вымирания.

### Функции построения графиков (utils/plotting_general.py)

#### `plot_experiment(exp_name, run_path)`
**Описание**: Основная функция построения графиков для эксперимента.
**Параметры**:
- `exp_name`: Название эксперимента
- `run_path`: Путь к данным запуска (опционально)

#### `create_line_plot(data, x_col, y_col, group_col, title, xlabel, ylabel, output_path, ...)`
**Описание**: Создает линейный график.
**Параметры**:
- `data`: DataFrame с данными
- `x_col`: Название колонки для оси X
- `y_col`: Название колонки для оси Y
- `group_col`: Колонка для группировки данных (для легенды)
- Другие параметры для стилизации и сохранения

#### `create_bar_plot(data, x_col, y_col, title, xlabel, ylabel, output_path)`
**Описание**: Создает столбчатую диаграмму.
**Параметры**: Аналогично create_line_plot

#### `load_summary_data(config_dirs, metric, group_by_column)`
**Описание**: Загружает сводные данные из нескольких конфигураций для сравнения.
**Возвращает**: DataFrame с агрегированными данными

## 5. Вложенные структуры данных

### Основные классы и их структура

#### Cow
```
Cow:
    - id: int
    - S, V, M, IQ, W, R, T0: float
    - mutation_rate: float
    - sexual_reproduce: int (0/1)
    - stomach_capacity: float
    - age: int
    - position: int
    - energy: float
    - alive: bool
    - target_partner_id: int
    - target_position: int
    - waiting_for_partner: bool
    - blacklist_partner_ids: set[int]
    - reproduction_age_threshold: float
    - traveled_distance: float
    - fixed_params: list[str]
```

#### World
```
World:
    - length: int
    - max_grass_amount: float
    - grass_speed: float
    - climate: dict
    - soil: dict
    - ticks_per_year: int
    - current_tick: int
    - monotonous_mode: bool
    - monotonous_zone: str
    - _climate_zones: ndarray
    - _soil_types: ndarray
    - _zone_idx: ndarray
    - _soil_factor: ndarray
    - _grass: ndarray
    - _max_grass: ndarray
    - _temperature: ndarray
    - patches: DirectAccessList
```

#### Simulation
```
Simulation:
    - config: dict
    - seed: int
    - ticks_per_year: int
    - years: int
    - max_ticks: int
    - world: World
    - cows: list[Cow]
    - all_cows: list[Cow]
    - dead_cows: list[Cow]
    - metrics_collector: MetricsCollector
    - current_tick: int
    - stats: dict
    - running: bool
    - paused: bool
```

#### MetricsCollector
```
MetricsCollector:
    - config: dict
    - metrics_config: dict
    - enabled: bool
    - enabled_groups: dict
    - metrics_data: defaultdict(list)
    - accumulated_data: dict
```

### Конфигурационные структуры

#### Конфигурация эксперимента
```
{
  "name": string,
  "description": string,
  "override": {
    "simulation.repeats": int,
    "simulation.years": int,
    "cows.mutation_rate": number | list[number],
    "cows.params.group": list[{
      "S": int,
      "V": int,
      "M": int,
      "IQ": int,
      "W": int,
      "R": int,
      "T0": int
    }],
    "cows.birth_energy": int,
    "cows.base_energy": int,
    "cows.use_intelligence": bool,
    "cows.stomach_size": int,
    "eco.grass_speed": float,
    "eco.max_grass_amount": int,
    "cows.sexual_reproduce": int
  }
}
```

#### Конфигурация графиков
```
{
  "group_by": {
    "path": string,
    "column": string,
    "mapping": object
  },
  "experiment_groups": {
    [group_id]: {
      "name": string,
      "configs": list[int],
      "mutation_rates": list[float]
    }
  },
  "plots": [
    {
      "metric": string | list[string],
      "aggregate": list[string],
      "type": "line" | "bar",
      "use_summary": bool,
      "xlabel": string,
      "ylabel": string,
      "title": string,
      "output": string,
      "tick_step": int,
      "by_experiment_group": bool,
      "subplot": bool,
      "subplot_params": {
        "rows": int,
        "cols": int
      }
    }
  ]
}
```

## Заключение

Проект "Симуляция эволюции коров" представляет собой сложную модель эволюционной динамики популяции в одномерном мире с различными экологическими условиями. Основная цель проекта - изучение влияния различных факторов (скорость мутации, тип размножения, климат, интеллект и т.д.) на эволюцию популяции и её адаптацию к окружающей среде.

Архитектура проекта хорошо структурирована и разделена на логические модули: агенты, окружающая среда, симуляция, метрики и эксперименты. Код организован в объектно-ориентированном стиле с четким разделением обязанностей между компонентами.

Система конфигурации позволяет гибко настраивать различные параметры экспериментов, а модуль построения графиков обеспечивает визуализацию результатов для анализа.
